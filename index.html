<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Un news feed avec Elasticsearch</title>

		<meta name="description" content="Retour d'expérience sur la réalisation du nouveau news feed de Viadeo à l'aide d'Elasticsearch.">
		<meta name="author" content="Greg Truchetet & Quentin Suire">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/default.css" id="theme">
		<link rel="stylesheet" href="css/overrides.css">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', include the PDF print sheet -->
		<script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">
			<div class="slides">
				<section data-markdown>
					<script type="text/template">
## A news feed with
# Elasticsearch

Feedback by [Greg Truchetet]() & [Quentin Suire]() @ [Viadeo](https://www.viadeo.com)

<small>Elasticsearch FR – 2014/12/17</small>
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
Who are we?

![Grumpf!](img/critters.png)
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Contents

1. What is a news feed?
	- Overview
	- Fan-out on write VS read
1. News feed prototype
	- Technical challenges
	- How to prototype?
	- Model
	- Query
1. News feed in production
	- Event-driven indexation
	- Pitfalls
	- Some figures
1. Questions?
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## What is a news feed?
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
![Viadeo screenshot](img/viadeo-news-feed-highlighted.png)
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Basic example

*I* <!-- .element: class="fragment highlight-green" data-fragment-index="1" -->
know
*Ned, John and Mary*. <!-- .element: class="fragment highlight-blue" data-fragment-index="2" -->

- consumer <!-- .element: class="fragment highlight-green" data-fragment-index="1" -->
- producers <!-- .element: class="fragment highlight-blue" data-fragment-index="2" -->

| Time  | Activity                     |
|-------|------------------------------|
| 16:00 | Ned posts a status           |
| 15:30 | John posts a status          |
| 14:00 | Mary updates her picture     |
| 12:45 | John adds a new job position |

**How to *efficiently* store and retrieve it?** <!-- .element: class="fragment important" -->
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Fan-out on write
# VS
## Fan-out on read
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Fan-out on write

Store pre-computed news feeds for each reader

![Bart](img/bart.gif)

### TODO illustrated example
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Fan-out on read

Store atomic news and aggregate a news feed at the query time

![Bart](img/aggregation.gif)

### TODO illustrated example
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## News feed prototype
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Technical challenges

- response time < 50ms <!-- .element: class="fragment" -->
- reasonable denormalization <!-- .element: class="fragment" -->
- easily maintainable <!-- .element: class="fragment" -->
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## How to prototype?

- Drive your prototype by the tests <!-- .element: class="fragment" -->
	- feature tests
	- load tests
- Be minimalist <!-- .element: class="fragment" -->
	- "You Aren't Gonna Need It"
	- "Keep it Simple, Stupid!"

**TODO add images!! `img/cucumber.png`, `img/gatling.png`**
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Model with fan-out on read

- aggregate on read
- does it complies with the tests?

**TODO**
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Activity Stream

> John adds a new job position

can be represented as

| Actor | Verb   | Object   | Target  |
|-------|--------|----------|---------|
| John  | add    | position | profile |
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## News document

```json
{
	"_id": "urn:viadeo:news:33",
	"producerId": "urn:viadeo:member:1",
	"published": "2014-12-17T12:45:00.000Z",
	"actor": {
		"id": "urn:viadeo:member:1",
		"objectType": "member",
		"displayName": "John"
	},
	"verb": "add",
	"object": {
		"id": "urn:viadeo:position:10",
		"objectType": "position",
		"displayName": "Software Engineer @ Viadeo"
	},
	"target": {
		"id": "urn:viadeo:profile:1",
		"objectType": "profile",
		"displayName": "John's profile"
	}
}
```
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Consumer network document

> I know Ned, John and Mary

can be represented as

```json
{
	"_id": "urn:viadeo:network:1",
	"producerIds": [
		"urn:viadeo:member:2",
		"urn:viadeo:member:3",
		"urn:viadeo:member:4"
	]
}
```
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Terms filter lookup query

```sh
curl -XPOST "http://localhost:9200/newsfeed/news/_search" -d
```

```json
{
	"query": {
		"filtered": {
			"query": {
				"match_all": {}
			},
			"filter": {
				"terms": {
					"producerId": {
						"index": "newsfeed_consumer_network",
						"type": "consumer_network",
						"id": "urn:viadeo:network:1",
						"path": "producerIds"
					}
				}
			}
		}
	}
}
```
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## News feed in production
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Pitfalls

- Terms filter cache is misleading
- Use filtered query instead of query and filter
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
## Questions?
					</script>
				</section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// Parallax scrolling
				// parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
				// parallaxBackgroundSize: '2100px 900px',

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
