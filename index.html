<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>A news feed with Elasticsearch</title>

        <meta name="description" content="Feedback about the design and the implementation of the news feed of Viadeo with Elasticsearch.">
        <meta name="author" content="Greg Truchetet and Quentin Suire">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/reveal.min.css">
        <link rel="stylesheet" href="css/theme/default.css" id="theme">
        <link rel="stylesheet" href="css/overrides.css">

        <!-- For syntax highlighting -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- If the query includes 'print-pdf', include the PDF print sheet -->
        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement( 'link' );
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = 'css/print/pdf.css';
                document.getElementsByTagName( 'head' )[0].appendChild( link );
            }
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="reveal">
            <div class="slides">
                <section data-markdown data-separator="^\n---\n$" data-vertical="^\n--\n$" data-transition="fade">
                    <script type="text/template">
## A news feed with
# Elasticsearch

Feedback by [Greg Truchetet]() & [Quentin Suire]() @ [Viadeo](https://www.viadeo.com)

<small>Elasticsearch FR â€“ 2014/12/17</small>

---

Who are we?

![Grumpf!](img/critters.png)

---

## Contents

1. What is a news feed?
1. News feed prototype
1. News feed in production
1. What is next?

---

<!-- .slide: data-background="#1b91ff" -->
## What is a news feed?

---

![Viadeo screenshot](img/new_dash.png)

---

## Basic example

*I* <!-- .element: class="fragment highlight-green" data-fragment-index="1" -->
know
*Ned, John and Mary*. <!-- .element: class="fragment highlight-blue" data-fragment-index="2" -->

- consumer <!-- .element: class="fragment highlight-green" data-fragment-index="1" -->
- producers <!-- .element: class="fragment highlight-blue" data-fragment-index="2" -->

| Time  | Activity                     |
|-------|------------------------------|
| 16:00 | Ned posts a status           |
| 15:30 | John posts a status          |
| 14:00 | Mary updates her picture     |
| 12:45 | John adds a new job position |

**How to *efficiently* store and retrieve it?** <!-- .element: class="fragment important" -->

---

<!-- .slide: data-background="#1b91ff" -->
## News feed prototype

---

## Technical challenges

- response time < 50ms (instead of 1.5 seconds on legacy)<!-- .element: class="fragment" -->
- reasonable denormalization (instead of full relational model on legacy) <!-- .element: class="fragment" -->
- easily maintainable (instead of ... you know what.) <!-- .element: class="fragment" -->

---

## How to prototype?

- Drive your prototype by the tests <!-- .element: class="fragment" -->
    - feature tests
    - load tests
- Be minimalist <!-- .element: class="fragment" -->
    - "You Aren't Gonna Need It"
    - "Keep it Simple, Stupid!"

---

## Functional Test

### (Cucumber)

```gherkin
Scenario: Show a news feed from several sources, sorted by date,
          first is the most recent
    Given I know "Ned", "John", "Mary"
      And "Ned" posts a status at 16h00
      And "John" posts a status at 15h30
      And "Jennyfer" comments a news at 14h18
      And "Mary" updates her picture at 14h00
      And "John" adds a new job position at 12h45
    When I get my news feed
    Then I see the following news:
      | time  | news                        |
      | 16h00 | Ned posts a status          |
      | 15h30 | John posts a status         |
      | 14h00 | Mary updates her picture    |
      | 12h45 | John adds a new job postion |
```

---

## Load Test

### (Gatling)

![Gatling](img/gatling.png)

---

 ## Storage strategies
- Fan-out on write<!-- .element: class="fragment" -->
- Fan-out on read<!-- .element: class="fragment" -->

---

## Fan-out on write 1/2

Store pre-computed news feeds for each reader

![Bart](img/bart.gif)

---

## Fan-out on write 2/2

![Fan-out on write](img/fan-out-on-write.svg)

---

## Fan-out on read 1/2

Store atomic news and aggregate a news feed at the query time

![Bart](img/aggregation.gif)

---

## Fan-out on read 2/2

![Fan-out on read](img/fan-out-on-read.svg)

---

## Our choice
- Fan out on read <!-- .element: class="fragment" -->
- Elasticsearch <!-- .element: class="fragment" -->

---

## Why Elasticsearch?
- Document oriented storage <!-- .element: class="fragment" -->
- Filtering capabilities <!-- .element: class="fragment" -->
- Promising technology <!-- .element: class="fragment" -->
- Already present in our infrastructure <!-- .element: class="fragment" -->

---

## Model with fan-out on read

- Two indices <!-- .element: class="fragment" -->
   - `newsfeed_consumer_network`
   - `newsfeed`

Build news feed on read <!-- .element: class="fragment" -->

*Terms filter lookup!* <!-- .element: class="fragment important" -->

---

## Consumer network document

> I know Ned, John and Mary

can be represented as

```
/newsfeed_consumer_network/consumer_network/urn:viadeo:member:me
```
```json
{
    "producerIds": [
        "urn:viadeo:member:ted",
        "urn:viadeo:member:john",
        "urn:viadeo:member:mary"
    ]
}
```

---

## Activity Stream

> John adds a new job position

can be represented as

| Actor | Verb   | Object   | Target  |
|-------|--------|----------|---------|
| John  | add    | position | profile |

---

## News document

```
/newsfeed/news/urn:viadeo:news:33
```
```json
{
    "producerId": "urn:viadeo:member:john",
    "published": "2014-12-17T12:45:00.000Z",
    "actor": {
        "id": "urn:viadeo:member:john",
        "objectType": "member",
        "displayName": "John"
    },
    "verb": "add",
    "object": {
        "id": "urn:viadeo:position:10",
        "objectType": "position",
        "displayName": "Software Engineer @ Viadeo"
    },
    "target": {
        "id": "urn:viadeo:profile:john",
        "objectType": "profile",
        "displayName": "John's profile"
    }
}
```

---

## Terms filter lookup query

```sh
curl -XPOST "http://localhost:9200/newsfeed/news/_search" -d
```

```json
{
    "query": {
        "filtered": {
            "query": {
                "match_all": {}
            },
            "filter": {
                "terms": {
                    "producerId": {
                        "index": "newsfeed_consumer_network",
                        "type": "consumer_network",
                        "id": "urn:viadeo:network:me",
                        "path": "producerIds"
                    }
                }
            }
        }
    }
}
```

---

## Terms filter lookup query

![Dog](img/happydog.gif)

---

<!-- .slide: data-background="#1b91ff" -->
## News feed in production

---

## Event-driven indexation

Viadeo internal platform is **event based**

- event ~ news
- indexer == listener
- near real-time indexation (some ms)

---

## Pitfall: conflict with consumer networks

### Problem

- one document per consumer with **all producers**
- conflict on update

### Solutions

- Quick & dirty: retry!
- Product-oriented: limit number of producers
- Best: use immutable document (consumer-producer)

---

## Pitfall: fear the default LRU cache

- Terms filter cache is misleading

**TODO**

---

## Pitfall: check your query

- Use filtered query instead of query and filter

**TODO**

---

## Some figures

**TODO**

- Cluster with 3 nodes
- 30M news
- avg response time = 40ms
- 15 req/s

---

## What comes next?

**TODO**

- scoring
- aggregation

---

<!-- .slide: data-background="#1b91ff" -->
## Questions?
                    </script>
                </section>
            </div>

        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.min.js"></script>

        <script>

            // Full list of configuration options available here:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

                // Parallax scrolling
                // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
                // parallaxBackgroundSize: '2100px 900px',

                // Optional libraries used to extend on reveal.js
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
                ]
            });

        </script>

    </body>
</html>
